<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>IPTV Cast Receiver</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
        }

        video {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            background: #000;
        }
    </style>
</head>

<body>
    <video id="media" autoplay></video>

    <!-- hls.js for HLS streams -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7"></script>

    <!-- Google Cast Receiver SDK v3 -->
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

    <script>
        'use strict';

        const TAG = '[Receiver]';
        const video = document.getElementById('media');
        let hls = null;

        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();

        console.log(TAG, 'ğŸš€ Custom IPTV receiver starting...');

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // Helper: clean up HLS playback
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        function cleanup() {
            if (hls) {
                hls.destroy();
                hls = null;
            }
            video.removeAttribute('src');
            video.load();
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // Intercept LOAD â€” we handle ALL content ourselves.
        // HLS â†’ hls.js, everything else â†’ video.src directly.
        // Chrome's <video> element on Chromecast can play
        // MKV, MP4, TS etc. with H.264/AAC codecs.
        // We NEVER let CAF handle it natively.
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            (request) => {
                const url = request.media.contentUrl || request.media.contentId;
                const contentType = (request.media.contentType || '').toLowerCase();
                console.log(TAG, 'ğŸ“¥ LOAD:', url);
                console.log(TAG, 'ğŸ“¦ type:', contentType);

                cleanup();

                const isHls = url && (
                    url.includes('.m3u8') ||
                    contentType.includes('mpegurl')
                );

                return new Promise((resolve) => {
                    if (isHls && Hls.isSupported()) {
                        // â”€â”€â”€ HLS via hls.js â”€â”€â”€
                        console.log(TAG, 'ğŸ¬ Using hls.js for HLS');

                        hls = new Hls({
                            debug: false,
                            enableWorker: true,
                            lowLatencyMode: false,
                            backBufferLength: 30,
                            maxBufferLength: 30,
                            maxMaxBufferLength: 60,
                            startLevel: -1,
                            fragLoadingMaxRetry: 10,
                            manifestLoadingMaxRetry: 6,
                            levelLoadingMaxRetry: 6,
                            fragLoadingRetryDelay: 1000,
                        });

                        hls.on(Hls.Events.MANIFEST_PARSED, (e, data) => {
                            console.log(TAG, 'âœ… HLS manifest parsed, levels:', data.levels.length);
                            video.play().catch(err =>
                                console.warn(TAG, 'âš ï¸ Autoplay:', err.message)
                            );
                        });

                        hls.on(Hls.Events.ERROR, (e, data) => {
                            console.error(TAG, 'âŒ HLS error:', data.type, data.details);
                            if (data.fatal) {
                                if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                                    console.log(TAG, 'ğŸ”„ Retrying...');
                                    hls.startLoad();
                                } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                                    console.log(TAG, 'ğŸ”„ Recovering media...');
                                    hls.recoverMediaError();
                                } else {
                                    console.error(TAG, 'ğŸ’€ Fatal error');
                                    cleanup();
                                }
                            }
                        });

                        hls.loadSource(url);
                        hls.attachMedia(video);

                    } else {
                        // â”€â”€â”€ Direct playback via video.src â”€â”€â”€
                        // Chrome's video element handles MP4, MKV (H.264), TS, etc.
                        console.log(TAG, 'ğŸ“º Direct playback via video.src');
                        video.src = url;
                        video.play().catch(err =>
                            console.warn(TAG, 'âš ï¸ Autoplay:', err.message)
                        );
                    }

                    // Return null for ALL cases â€” we always handle playback ourselves
                    resolve(null);
                });
            }
        );

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // Handle controls from sender app
        // We manage playback, so intercept all commands
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.PAUSE,
            (request) => { video.pause(); return null; }
        );

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.PLAY,
            (request) => { video.play(); return null; }
        );

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.SEEK,
            (request) => {
                if (request.currentTime !== undefined) {
                    video.currentTime = request.currentTime;
                }
                return null;
            }
        );

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.STOP,
            (request) => { cleanup(); return null; }
        );

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.SET_VOLUME,
            (request) => {
                if (request.volume) {
                    if (request.volume.level !== undefined) video.volume = request.volume.level;
                    if (request.volume.muted !== undefined) video.muted = request.volume.muted;
                }
                return null;
            }
        );

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // Debug logging
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        video.addEventListener('playing', () => console.log(TAG, 'ğŸ‰ PLAYING'));
        video.addEventListener('pause', () => console.log(TAG, 'â¸ï¸ PAUSED'));
        video.addEventListener('error', () => {
            const err = video.error;
            console.error(TAG, 'âŒ Video error:', err ? `code=${err.code} msg=${err.message}` : 'unknown');
        });
        video.addEventListener('waiting', () => console.log(TAG, 'â³ BUFFERING'));
        video.addEventListener('loadeddata', () => console.log(TAG, 'ğŸ“¦ Data loaded'));
        video.addEventListener('canplay', () => console.log(TAG, 'â–¶ï¸ Can play'));

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // Start
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        const options = new cast.framework.CastReceiverOptions();
        options.disableIdleTimeout = true;
        options.mediaElement = video;

        context.start(options);
        console.log(TAG, 'âœ… Receiver started');
    </script>
</body>

</html>