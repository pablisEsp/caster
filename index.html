<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>IPTV Cast Receiver</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
        }

        video {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            background: #000;
        }
    </style>
</head>

<body>
    <video id="media" autoplay></video>

    <!-- hls.js for HLS streams -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7"></script>

    <!-- Google Cast Receiver SDK v3 -->
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

    <script>
        'use strict';

        const TAG = '[Receiver]';
        const video = document.getElementById('media');
        let hls = null;
        let customPlayback = false; // true when WE manage playback (HLS)

        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();

        console.log(TAG, 'ğŸš€ Custom IPTV receiver starting...');

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // Helper: clean up HLS playback
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        function cleanup() {
            if (hls) {
                hls.destroy();
                hls = null;
            }
            customPlayback = false;
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // Intercept LOAD
        // HLS â†’ hls.js (custom, return null)
        // Non-HLS â†’ CAF native (return request, creates media session)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            (request) => {
                const url = request.media.contentUrl || request.media.contentId;
                const contentType = (request.media.contentType || '').toLowerCase();
                console.log(TAG, 'ğŸ“¥ LOAD:', url);
                console.log(TAG, 'ğŸ“¦ type:', contentType);

                cleanup();

                const isHls = url && (
                    url.includes('.m3u8') ||
                    contentType.includes('mpegurl')
                );

                if (isHls && Hls.isSupported()) {
                    // â”€â”€â”€ HLS via hls.js (custom playback) â”€â”€â”€
                    console.log(TAG, 'ğŸ¬ Using hls.js for HLS');
                    customPlayback = true;

                    return new Promise((resolve) => {
                        hls = new Hls({
                            debug: false,
                            enableWorker: true,
                            lowLatencyMode: false,
                            backBufferLength: 30,
                            maxBufferLength: 30,
                            maxMaxBufferLength: 60,
                            startLevel: -1,
                            fragLoadingMaxRetry: 10,
                            manifestLoadingMaxRetry: 6,
                            levelLoadingMaxRetry: 6,
                            fragLoadingRetryDelay: 1000,
                        });

                        hls.on(Hls.Events.MANIFEST_PARSED, (e, data) => {
                            console.log(TAG, 'âœ… HLS manifest parsed, levels:', data.levels.length);
                            video.play().catch(err =>
                                console.warn(TAG, 'âš ï¸ Autoplay:', err.message)
                            );
                        });

                        hls.on(Hls.Events.ERROR, (e, data) => {
                            console.error(TAG, 'âŒ HLS error:', data.type, data.details);
                            if (data.fatal) {
                                if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                                    console.log(TAG, 'ğŸ”„ Retrying...');
                                    hls.startLoad();
                                } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                                    console.log(TAG, 'ğŸ”„ Recovering media...');
                                    hls.recoverMediaError();
                                } else {
                                    console.error(TAG, 'ğŸ’€ Fatal error');
                                    cleanup();
                                }
                            }
                        });

                        hls.loadSource(url);
                        hls.attachMedia(video);
                        resolve(null); // Prevent CAF from loading
                    });

                } else {
                    // â”€â”€â”€ Non-HLS: let CAF handle natively â”€â”€â”€
                    // CAF creates a media session â†’ sender controls work
                    // Override unsupported MIME types to video/mp4
                    console.log(TAG, 'ğŸ“º CAF native playback');

                    if (!contentType ||
                        contentType.includes('matroska') ||
                        contentType.includes('msvideo') ||
                        contentType.includes('quicktime')) {
                        request.media.contentType = 'video/mp4';
                        console.log(TAG, 'ğŸ”€ Content type â†’ video/mp4');
                    }

                    // Ensure contentUrl is set (some versions of the SDK need it)
                    if (!request.media.contentUrl && request.media.contentId) {
                        request.media.contentUrl = request.media.contentId;
                    }

                    return request; // CAF handles it, media session created
                }
            }
        );

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // Handle controls â€” only intercept when custom (HLS) playback
        // For non-HLS, CAF handles controls natively
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.PAUSE,
            (request) => {
                if (customPlayback) { video.pause(); return null; }
                return request;
            }
        );

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.PLAY,
            (request) => {
                if (customPlayback) { video.play(); return null; }
                return request;
            }
        );

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.SEEK,
            (request) => {
                if (customPlayback && request.currentTime !== undefined) {
                    video.currentTime = request.currentTime;
                    return null;
                }
                return request;
            }
        );

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.STOP,
            (request) => {
                if (customPlayback) { cleanup(); return null; }
                return request;
            }
        );

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.SET_VOLUME,
            (request) => {
                if (customPlayback && request.volume) {
                    if (request.volume.level !== undefined) video.volume = request.volume.level;
                    if (request.volume.muted !== undefined) video.muted = request.volume.muted;
                    return null;
                }
                return request;
            }
        );

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // Debug logging
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        video.addEventListener('playing', () => console.log(TAG, 'ğŸ‰ PLAYING'));
        video.addEventListener('pause', () => console.log(TAG, 'â¸ï¸ PAUSED'));
        video.addEventListener('error', () => {
            const err = video.error;
            console.error(TAG, 'âŒ Video error:', err ? `code=${err.code} msg=${err.message}` : 'unknown');
        });
        video.addEventListener('waiting', () => console.log(TAG, 'â³ BUFFERING'));
        video.addEventListener('loadeddata', () => console.log(TAG, 'ğŸ“¦ Data loaded'));
        video.addEventListener('canplay', () => console.log(TAG, 'â–¶ï¸ Can play'));

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // Start
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        const options = new cast.framework.CastReceiverOptions();
        options.disableIdleTimeout = true;
        options.mediaElement = video;

        context.start(options);
        console.log(TAG, 'âœ… Receiver started');
    </script>
</body>

</html>